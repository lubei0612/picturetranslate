# Implementation Log: Task 1.5.1

**Summary:** 完成翻译引擎列表与文字图层 API，串联 LayerService 并为翻译接口增加引擎选择

**Timestamp:** 2025-12-04T13:49:24.311Z
**Log ID:** 9d128c9e-2bf9-49cc-8932-92cc20f560a1

---

## Statistics

- **Lines Added:** +780
- **Lines Removed:** -180
- **Files Changed:** 17
- **Net Change:** 600

## Files Modified
- api/dependencies.py
- api/main.py
- api/routes/__init__.py
- api/routes/translate.py
- api/schemas/engine.py
- api/schemas/layer.py
- core/processor.py
- core/engines/base.py
- core/engines/registry.py
- services/translator.py
- frontend/src/shared/types/api.ts
- frontend/src/shared/types/layer.ts
- utils/image.py
- tests/test_api.py
- tests/test_services.py

## Files Created
- api/routes/engines.py
- api/routes/layers.py

---

## Artifacts

### API Endpoints

#### GET /api/engines
- **Purpose:** 返回已注册翻译引擎及健康状态
- **Location:** api/routes/engines.py:8-34
- **Request Format:** 无
- **Response Format:** { default: string, engines: EngineInfo[] }

#### GET /api/translations/{translation_id}/layers
- **Purpose:** 列出 translation 的文字图层
- **Location:** api/routes/layers.py:28-35
- **Request Format:** Path param translation_id
- **Response Format:** TextLayerResponse[]

#### PATCH /api/layers/{layer_id}
- **Purpose:** 按乐观锁更新单个图层
- **Location:** api/routes/layers.py:38-55
- **Request Format:** TextLayerUpdate
- **Response Format:** TextLayerResponse

#### POST /api/layers/batch
- **Purpose:** 批量更新多个图层
- **Location:** api/routes/layers.py:58-83
- **Request Format:** TextLayerBatchUpdateRequest
- **Response Format:** TextLayerResponse[]

### Functions

#### EngineRegistry.describe_engines
- **Purpose:** 为 /api/engines 提供引擎描述
- **Location:** core/engines/registry.py:35-61
- **Signature:** () -> list[dict[str, object]]
- **Exported:** Yes

#### EngineRegistry.get_default
- **Purpose:** 返回默认引擎名称
- **Location:** core/engines/registry.py:24-33
- **Signature:** () -> str
- **Exported:** Yes

### Integrations

#### Integration
- **Description:** LayerService 通过 FastAPI DI 暴露给新图层路由；前端共享类型同步 translationId 字段
- **Frontend Component:** shared/types/layer.ts
- **Backend Endpoint:** /api/translations/{id}/layers 等
- **Data Flow:** 前端调用→FastAPI route→LayerService→TextLayer ORM

