{
  "id": "snapshot_1764851140719_e8fz20e37",
  "approvalId": "approval_1764851135430_b147xna4t",
  "approvalTitle": "Design: 三套方案对比 + 架构设计",
  "version": 2,
  "timestamp": "2025-12-04T12:25:40.719Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design: SaaS UI 重构与后端增强\n\n## 方案对比（三选一）\n\n### 方案 A: 全量重写 + Feature Slicing\n**实现方式**：删除现有前端代码，按 Feature Slicing 从零构建\n\n| 优点 | 缺点 |\n|------|------|\n| 架构最干净 | 工作量最大（~25h） |\n| 无历史包袱 | 风险高，需完整回归测试 |\n| 完全符合 AGENTS.md | 现有功能暂时不可用 |\n\n**适用场景**：时间充裕、追求长期可维护性\n\n---\n\n### 方案 B: 渐进式迁移 + 外科手术\n**实现方式**：保留现有代码运行，新建 features/ 目录，逐个模块迁移\n\n| 优点 | 缺点 |\n|------|------|\n| 风险可控，随时可回滚 | 过渡期存在两套代码 |\n| 现有功能持续可用 | 需要维护兼容层 |\n| 可分阶段交付 | 架构过渡期略混乱 |\n\n**适用场景**：生产环境已上线、需要持续交付\n\n---\n\n### 方案 C: 外部设计稿 Staging 清洗\n**实现方式**：将设计稿代码放入 _staging/，Claude 外科手术拆解后合并\n\n| 优点 | 缺点 |\n|------|------|\n| 复用设计稿 UI 加速开发 | 需要大量拆解重构工作 |\n| 符合 Section 16 规范 | 设计稿代码质量未知 |\n| UI 一致性有保障 | 可能引入设计稿的技术债 |\n\n**适用场景**：有高质量外部设计稿可参考\n\n---\n\n### 推荐选择：方案 B + C 混合\n**理由**：\n1. 渐进式迁移保证现有功能可用（方案 B）\n2. 设计稿 UI 走 Staging 清洗流程（方案 C）\n3. 符合 AGENTS.md Section 14.1 迭代式开发 + Section 16 外部代码协议\n\n---\n\n## 架构概览\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                        Frontend                              │\n│  ┌─────────────────────────────────────────────────────────┐ │\n│  │                    layouts/                              │ │\n│  │         DesktopLayout  |  MobileLayout                  │ │\n│  └─────────────────────────────────────────────────────────┘ │\n│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │\n│  │ features/│ │ features/│ │ features/│ │ features/│        │\n│  │dashboard │ │ editor   │ │ history  │ │ settings │        │\n│  └──────────┘ └──────────┘ └──────────┘ └──────────┘        │\n│  ┌─────────────────────────────────────────────────────────┐ │\n│  │                    shared/                               │ │\n│  │    components | hooks | utils | types | api              │ │\n│  └─────────────────────────────────────────────────────────┘ │\n└─────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌─────────────────────────────────────────────────────────────┐\n│                        Backend                               │\n│  ┌─────────────────────────────────────────────────────────┐ │\n│  │                    api/routes/                           │ │\n│  │   translate | jobs | history | layers | engines         │ │\n│  └─────────────────────────────────────────────────────────┘ │\n│  ┌─────────────────────────────────────────────────────────┐ │\n│  │                    services/                             │ │\n│  │   translator | job_queue | history | layer_service      │ │\n│  └─────────────────────────────────────────────────────────┘ │\n│  ┌─────────────────────────────────────────────────────────┐ │\n│  │                    core/                                 │ │\n│  │        engines/                   models/                │ │\n│  │   ┌─────────────────┐      ┌─────────────────┐          │ │\n│  │   │ EngineRegistry  │      │  text_layers    │          │ │\n│  │   │ AliyunEngine    │      │  translation    │          │ │\n│  │   │ DeepLEngine     │      │  job            │          │ │\n│  │   │ GoogleEngine    │      └─────────────────┘          │ │\n│  │   └─────────────────┘                                   │ │\n│  └─────────────────────────────────────────────────────────┘ │\n└─────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## 前端设计\n\n### 目录结构\n```\nfrontend/src/\n├── features/\n│   ├── dashboard/\n│   │   ├── components/\n│   │   │   ├── ProjectCard.tsx\n│   │   │   ├── ProjectGrid.tsx\n│   │   │   ├── UploadZone.tsx\n│   │   │   └── FilterBar.tsx\n│   │   ├── hooks/\n│   │   │   └── useProjects.ts\n│   │   ├── api/\n│   │   │   └── projectApi.ts\n│   │   ├── types.ts\n│   │   └── index.ts\n│   ├── editor/\n│   │   ├── components/\n│   │   │   ├── ImageViewer.tsx\n│   │   │   ├── LayerList.tsx\n│   │   │   ├── LayerPanel.tsx\n│   │   │   ├── Toolbar.tsx\n│   │   │   └── CropTool.tsx\n│   │   ├── hooks/\n│   │   │   ├── useLayers.ts\n│   │   │   └── useEditor.ts\n│   │   ├── api/\n│   │   │   └── layerApi.ts\n│   │   ├── types.ts\n│   │   └── index.ts\n│   ├── history/\n│   │   ├── components/\n│   │   │   ├── HistoryList.tsx\n│   │   │   └── HistoryItem.tsx\n│   │   ├── hooks/\n│   │   │   └── useHistoryList.ts\n│   │   └── index.ts\n│   └── settings/\n│       ├── components/\n│       │   ├── EngineSelector.tsx\n│       │   └── LanguageConfig.tsx\n│       ├── hooks/\n│       │   └── useSettings.ts\n│       └── index.ts\n├── shared/\n│   ├── components/\n│   │   ├── Button.tsx\n│   │   ├── Modal.tsx\n│   │   ├── Toast.tsx\n│   │   ├── Skeleton.tsx\n│   │   └── EmptyState.tsx\n│   ├── hooks/\n│   │   ├── useBreakpoint.ts\n│   │   ├── useJobPolling.ts\n│   │   └── useOptimisticUpdate.ts\n│   ├── utils/\n│   │   ├── imageValidation.ts\n│   │   └── errorHandler.ts\n│   ├── types/\n│   │   ├── project.ts\n│   │   ├── layer.ts\n│   │   └── api.ts\n│   └── api/\n│       └── client.ts\n├── layouts/\n│   ├── DesktopLayout.tsx\n│   ├── MobileLayout.tsx\n│   └── index.ts\n├── App.tsx\n└── main.tsx\n```\n\n### 核心 Interface\n\n```typescript\n// shared/types/project.ts\ninterface Project {\n  id: string;\n  name: string;\n  thumbnail: string;\n  currentStage: 'translating' | 'editing' | 'completed';\n  progress: number;\n  createdAt: string;\n  updatedAt: string;\n  isDemo?: boolean;\n}\n\n// shared/types/layer.ts\ninterface TextLayer {\n  id: string;\n  translationId: string;\n  bbox: [number, number, number, number]; // [x, y, w, h]\n  originalText: string;\n  translatedText: string;\n  style: LayerStyle;\n  version: number; // 乐观锁\n}\n\ninterface LayerStyle {\n  fontFamily: string;\n  fontSize: number;\n  fontColor: string;\n  backgroundColor?: string;\n  rotation: number;\n}\n\n// shared/types/api.ts\ninterface ApiResponse<T> {\n  code: string;\n  message: string;\n  data?: T;\n  detail?: unknown;\n}\n\ninterface JobResponse {\n  jobId: string;\n  status: 'pending' | 'processing' | 'completed' | 'failed';\n  progress?: number;\n  result?: unknown;\n}\n```\n\n### 响应式方案\n\n```typescript\n// shared/hooks/useBreakpoint.ts\nconst BREAKPOINTS = {\n  mobile: 0,\n  tablet: 768,\n  desktop: 1024,\n} as const;\n\nfunction useBreakpoint() {\n  const [breakpoint, setBreakpoint] = useState<keyof typeof BREAKPOINTS>('desktop');\n  \n  useEffect(() => {\n    const handleResize = () => {\n      const width = window.innerWidth;\n      if (width < 768) setBreakpoint('mobile');\n      else if (width < 1024) setBreakpoint('tablet');\n      else setBreakpoint('desktop');\n    };\n    // ...\n  }, []);\n  \n  return { breakpoint, isMobile: breakpoint === 'mobile' };\n}\n```\n\n---\n\n## 后端设计\n\n### 策略模式 - 翻译引擎\n\n```python\n# core/engines/base.py\nfrom abc import ABC, abstractmethod\nfrom typing import Optional\nfrom pydantic import BaseModel\n\nclass TranslateResult(BaseModel):\n    translated_image: bytes\n    layers: list[dict]\n    engine_name: str\n\nclass TranslateEngine(ABC):\n    name: str\n    \n    @abstractmethod\n    async def translate(\n        self, \n        image: bytes, \n        source_lang: str, \n        target_lang: str,\n        mask: Optional[bytes] = None\n    ) -> TranslateResult:\n        pass\n    \n    @abstractmethod\n    async def health_check(self) -> bool:\n        pass\n\n\n# core/engines/registry.py\nfrom typing import Dict, Type\nimport asyncio\n\nclass EngineRegistry:\n    _engines: Dict[str, TranslateEngine] = {}\n    _healthy: Dict[str, bool] = {}\n    \n    @classmethod\n    def register(cls, engine: TranslateEngine):\n        cls._engines[engine.name] = engine\n        cls._healthy[engine.name] = True\n    \n    @classmethod\n    def get(cls, name: str) -> TranslateEngine:\n        if name not in cls._engines:\n            raise ValueError(f\"Engine {name} not found\")\n        if not cls._healthy.get(name):\n            raise RuntimeError(f\"Engine {name} is unhealthy\")\n        return cls._engines[name]\n    \n    @classmethod\n    def list_available(cls) -> list[str]:\n        return [k for k, v in cls._healthy.items() if v]\n    \n    @classmethod\n    async def fallback_translate(cls, *args, preferred: str = None, **kwargs):\n        \"\"\"熔断降级：优先使用指定引擎，失败后自动切换\"\"\"\n        engines = [preferred] if preferred else []\n        engines += [e for e in cls._engines if e != preferred]\n        \n        for engine_name in engines:\n            try:\n                engine = cls.get(engine_name)\n                return await engine.translate(*args, **kwargs)\n            except Exception as e:\n                cls._healthy[engine_name] = False\n                continue\n        raise RuntimeError(\"All engines failed\")\n```\n\n### 数据库模型\n\n```python\n# models/text_layer.py\nfrom sqlalchemy import Column, Integer, String, JSON, ForeignKey, DateTime\nfrom sqlalchemy.orm import relationship\nfrom core.database import Base\nimport datetime\n\nclass TextLayer(Base):\n    __tablename__ = \"text_layers\"\n    \n    id = Column(Integer, primary_key=True, autoincrement=True)\n    translation_id = Column(Integer, ForeignKey(\"translations.id\"), nullable=False)\n    bbox = Column(JSON, nullable=False)  # [x, y, w, h]\n    original_text = Column(String, nullable=False)\n    translated_text = Column(String, nullable=False)\n    style = Column(JSON, nullable=False)\n    version = Column(Integer, default=1)  # 乐观锁\n    created_at = Column(DateTime, default=datetime.datetime.utcnow)\n    updated_at = Column(DateTime, onupdate=datetime.datetime.utcnow)\n    \n    translation = relationship(\"Translation\", back_populates=\"layers\")\n```\n\n### API 端点设计\n\n| Method | Path | 描述 | 返回 |\n|--------|------|------|------|\n| GET | `/api/engines` | 获取可用引擎列表 | `{ engines: string[] }` |\n| GET | `/api/translations/{id}/layers` | 获取图层列表 | `{ layers: TextLayer[] }` |\n| PATCH | `/api/layers/{id}` | 更新图层（需 version） | `{ layer: TextLayer }` or `409 Conflict` |\n| POST | `/api/layers/batch` | 批量更新图层 | `{ layers: TextLayer[] }` |\n| POST | `/api/images/{id}/crop` | 异步裁剪 | `{ jobId: string }` |\n| POST | `/api/images/{id}/inpaint` | 异步消除笔 | `{ jobId: string }` |\n\n### 错误码规范\n\n```python\n# core/exceptions.py\nERROR_CODES = {\n    \"VALIDATION_ERROR\": (400, \"请求参数校验失败\"),\n    \"NOT_FOUND\": (404, \"资源不存在\"),\n    \"VERSION_CONFLICT\": (409, \"数据已被修改，请刷新后重试\"),\n    \"ENGINE_UNAVAILABLE\": (503, \"翻译引擎暂不可用\"),\n    \"RATE_LIMITED\": (429, \"请求过于频繁\"),\n}\n```\n\n---\n\n## 技术决策\n\n| 决策点 | 选择 | 理由 |\n|--------|------|------|\n| 前端路由 | React Router v6 | 多页面结构，支持懒加载 |\n| 状态管理 | Zustand | 轻量，Feature Slicing 友好 |\n| HTTP Client | Axios | 拦截器、错误处理完善 |\n| 后端异步 | Celery + Redis | 成熟方案，替代 ThreadPool |\n| 乐观锁 | version 字段 | 简单有效，无需分布式锁 |\n\n---\n\n## 审查共识\n\n### Claude (前端/架构) 确认\n- [x] Feature Slicing 目录结构合理\n- [x] Interface 定义完整\n- [x] 响应式方案可行\n\n### Codex (后端/性能) 确认\n- [x] 策略模式 + 熔断降级设计合理\n- [x] text_layers 表结构正确\n- [x] 乐观锁防并发覆盖\n- [x] 异步 Job 避免阻塞\n\n**Status: APPROVED_BY_BOTH**\n",
  "fileStats": {
    "size": 14720,
    "lines": 401,
    "lastModified": "2025-12-04T12:22:04.915Z"
  },
  "comments": []
}