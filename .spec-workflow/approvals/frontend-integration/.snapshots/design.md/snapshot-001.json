{
  "id": "snapshot_1764817359042_sv7m1v39x",
  "approvalId": "approval_1764817359039_hznp435jl",
  "approvalTitle": "Design Document - FastAPI + React 分层架构设计",
  "version": 1,
  "timestamp": "2025-12-04T03:02:39.042Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Frontend Integration\n\n## Overview\n\n将 picturetranslate 后端从 Streamlit 重构为 FastAPI REST API，与 crossborder-ai React 前端整合，实现前后端分离的图片翻译产品。\n\n## Architecture\n\n### 系统架构图\n\n```\n┌─────────────────┐         ┌─────────────────────────────────┐\n│  React Frontend │         │        FastAPI Backend          │\n│  (crossborder)  │         │                                 │\n├─────────────────┤  HTTP   ├─────────────────────────────────┤\n│  Dashboard      │────────▶│  POST /api/translate            │\n│  - Upload       │         │  GET  /health                   │\n│  - Language     │◀────────│                                 │\n│                 │         ├─────────────────────────────────┤\n│  Editor         │         │  Services Layer                 │\n│  - Preview      │         │  ├─ TranslatorService           │\n│  - Download     │         │  ├─ CacheService (LRU)          │\n└─────────────────┘         │  └─ ImageValidator              │\n                            ├─────────────────────────────────┤\n                            │  processor.py (核心逻辑)         │\n                            │  └─ ImageTranslator             │\n                            │     └─ Aliyun API               │\n                            └─────────────────────────────────┘\n```\n\n### 后端目录结构\n\n```\npicturetranslate/\n├── api/\n│   ├── __init__.py\n│   ├── main.py              # FastAPI 应用入口、生命周期\n│   ├── routes/\n│   │   ├── __init__.py\n│   │   ├── translate.py     # POST /api/translate\n│   │   └── health.py        # GET /health\n│   └── dependencies.py      # 依赖注入\n├── core/\n│   ├── __init__.py\n│   ├── config.py            # Settings (pydantic-settings)\n│   └── exceptions.py        # 自定义异常 + handlers\n├── services/\n│   ├── __init__.py\n│   ├── translator.py        # 封装 processor.ImageTranslator\n│   └── cache.py             # LRU 缓存 (基于 image hash)\n├── utils/\n│   ├── __init__.py\n│   ├── image.py             # 图片验证、hash 计算\n│   └── retry.py             # 重试装饰器\n├── processor.py             # [保留] 核心翻译逻辑不变\n├── assets/\n│   └── SourceHanSansSC-Bold.otf\n├── tests/\n├── requirements.txt         # [更新] 添加 fastapi, uvicorn\n└── Dockerfile               # [更新] 启动命令改为 uvicorn\n```\n\n## Component Design\n\n### 1. API 层 (api/)\n\n#### main.py - 应用入口\n\n```python\nfrom fastapi import FastAPI\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom contextlib import asynccontextmanager\n\nfrom api.routes import translate, health\nfrom core.config import settings\nfrom core.exceptions import register_exception_handlers\n\n@asynccontextmanager\nasync def lifespan(app: FastAPI):\n    # 启动时初始化\n    yield\n    # 关闭时清理\n\napp = FastAPI(\n    title=\"图片翻译 API\",\n    version=\"1.0.0\",\n    lifespan=lifespan\n)\n\n# CORS 配置\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=settings.CORS_ORIGINS,\n    allow_methods=[\"GET\", \"POST\"],\n    allow_headers=[\"*\"],\n)\n\n# 路由\napp.include_router(health.router)\napp.include_router(translate.router, prefix=\"/api\")\n\n# 异常处理\nregister_exception_handlers(app)\n```\n\n#### routes/translate.py - 翻译接口\n\n```python\nfrom fastapi import APIRouter, UploadFile, File, Form, Depends, HTTPException\nfrom fastapi.responses import Response\nimport hashlib\nfrom concurrent.futures import ThreadPoolExecutor\n\nfrom services.translator import TranslatorService\nfrom services.cache import CacheService\nfrom utils.image import validate_image, compute_hash\nfrom core.config import settings\n\nrouter = APIRouter(tags=[\"translate\"])\nexecutor = ThreadPoolExecutor(max_workers=4)\n\n@router.post(\"/translate\")\nasync def translate_image(\n    file: UploadFile = File(...),\n    source_lang: str = Form(default=\"auto\"),\n    target_lang: str = Form(default=\"zh\"),\n    field: str = Form(default=\"e-commerce\"),\n    enable_postprocess: bool = Form(default=True),\n    translator: TranslatorService = Depends(),\n    cache: CacheService = Depends(),\n):\n    \"\"\"\n    翻译图片中的文字\n    \n    - file: 图片文件 (multipart/form-data)\n    - source_lang: 源语言 (auto/en/zh/ja/ko/fr/de/es/ru)\n    - target_lang: 目标语言\n    - field: 领域 (e-commerce/general)\n    - enable_postprocess: 启用后处理优化\n    \n    Returns: PNG 图片 (image/png)\n    \"\"\"\n    # 1. 读取文件\n    content = await file.read()\n    \n    # 2. 验证图片\n    is_valid, error = validate_image(content, file.content_type)\n    if not is_valid:\n        raise HTTPException(status_code=400, detail=error)\n    \n    # 3. 检查缓存\n    cache_key = compute_hash(content, source_lang, target_lang, field)\n    cached = cache.get(cache_key)\n    if cached:\n        return Response(content=cached, media_type=\"image/png\")\n    \n    # 4. 同步翻译 (线程池隔离)\n    loop = asyncio.get_event_loop()\n    result_bytes = await loop.run_in_executor(\n        executor,\n        translator.translate,\n        content, source_lang, target_lang, field, enable_postprocess\n    )\n    \n    # 5. 存入缓存\n    cache.set(cache_key, result_bytes)\n    \n    return Response(content=result_bytes, media_type=\"image/png\")\n```\n\n### 2. 核心配置层 (core/)\n\n#### config.py - 环境变量\n\n```python\nfrom pydantic_settings import BaseSettings\nfrom typing import List\n\nclass Settings(BaseSettings):\n    # 阿里云\n    ALI_ACCESS_KEY_ID: str\n    ALI_ACCESS_KEY_SECRET: str\n    \n    # CORS\n    CORS_ORIGINS: List[str] = [\"http://localhost:3000\", \"http://localhost:5173\"]\n    \n    # 限制\n    MAX_FILE_SIZE: int = 10 * 1024 * 1024  # 10MB\n    MAX_DIMENSION: int = 8192\n    \n    # 缓存\n    CACHE_MAX_SIZE: int = 100\n    CACHE_TTL: int = 3600  # 1小时\n    \n    # 重试\n    RETRY_MAX_ATTEMPTS: int = 3\n    RETRY_DELAY: float = 1.0\n    \n    class Config:\n        env_file = \".env\"\n\nsettings = Settings()\n```\n\n#### exceptions.py - 异常处理\n\n```python\nfrom fastapi import FastAPI, Request\nfrom fastapi.responses import JSONResponse\n\nclass TranslationError(Exception):\n    def __init__(self, message: str, code: str = \"TRANSLATION_ERROR\"):\n        self.message = message\n        self.code = code\n\nclass ValidationError(Exception):\n    def __init__(self, message: str):\n        self.message = message\n\ndef register_exception_handlers(app: FastAPI):\n    @app.exception_handler(TranslationError)\n    async def translation_error_handler(request: Request, exc: TranslationError):\n        return JSONResponse(\n            status_code=500,\n            content={\"error\": exc.code, \"message\": exc.message}\n        )\n    \n    @app.exception_handler(ValidationError)\n    async def validation_error_handler(request: Request, exc: ValidationError):\n        return JSONResponse(\n            status_code=400,\n            content={\"error\": \"VALIDATION_ERROR\", \"message\": exc.message}\n        )\n```\n\n### 3. 服务层 (services/)\n\n#### translator.py - 翻译服务\n\n```python\nfrom PIL import Image\nfrom io import BytesIO\nimport logging\n\nfrom processor import ImageTranslator\nfrom core.config import settings\nfrom utils.retry import retry_on_failure\n\nlogger = logging.getLogger(__name__)\n\nclass TranslatorService:\n    def __init__(self):\n        self._translator = None\n    \n    @property\n    def translator(self) -> ImageTranslator:\n        if self._translator is None:\n            self._translator = ImageTranslator(\n                access_key_id=settings.ALI_ACCESS_KEY_ID,\n                access_key_secret=settings.ALI_ACCESS_KEY_SECRET\n            )\n        return self._translator\n    \n    @retry_on_failure(max_attempts=3, delay=1.0)\n    def translate(\n        self,\n        image_bytes: bytes,\n        source_lang: str,\n        target_lang: str,\n        field: str,\n        enable_postprocess: bool\n    ) -> bytes:\n        \"\"\"执行翻译，返回 PNG bytes\"\"\"\n        image = Image.open(BytesIO(image_bytes))\n        \n        result = self.translator.translate(\n            image=image,\n            source_lang=source_lang,\n            target_lang=target_lang,\n            field=field,\n            enable_postprocess=enable_postprocess\n        )\n        \n        # 转为 PNG bytes\n        buffer = BytesIO()\n        result.save(buffer, format=\"PNG\")\n        return buffer.getvalue()\n```\n\n#### cache.py - LRU 缓存\n\n```python\nfrom functools import lru_cache\nfrom collections import OrderedDict\nimport threading\nimport time\n\nfrom core.config import settings\n\nclass CacheService:\n    \"\"\"线程安全的 LRU 缓存，支持 TTL\"\"\"\n    \n    def __init__(self):\n        self._cache = OrderedDict()\n        self._lock = threading.Lock()\n        self._max_size = settings.CACHE_MAX_SIZE\n        self._ttl = settings.CACHE_TTL\n    \n    def get(self, key: str) -> bytes | None:\n        with self._lock:\n            if key not in self._cache:\n                return None\n            \n            value, timestamp = self._cache[key]\n            \n            # 检查 TTL\n            if time.time() - timestamp > self._ttl:\n                del self._cache[key]\n                return None\n            \n            # 移到末尾 (LRU)\n            self._cache.move_to_end(key)\n            return value\n    \n    def set(self, key: str, value: bytes):\n        with self._lock:\n            if key in self._cache:\n                self._cache.move_to_end(key)\n            \n            self._cache[key] = (value, time.time())\n            \n            # 超出容量，删除最旧\n            while len(self._cache) > self._max_size:\n                self._cache.popitem(last=False)\n```\n\n### 4. 工具层 (utils/)\n\n#### image.py - 图片验证\n\n```python\nimport hashlib\nfrom PIL import Image\nfrom io import BytesIO\n\nfrom core.config import settings\n\nALLOWED_TYPES = {\"image/jpeg\", \"image/png\", \"image/webp\"}\n\ndef validate_image(content: bytes, content_type: str) -> tuple[bool, str]:\n    \"\"\"验证图片格式和尺寸\"\"\"\n    # MIME 类型\n    if content_type not in ALLOWED_TYPES:\n        return False, f\"不支持的图片格式，仅支持 JPG、PNG、WebP\"\n    \n    # 文件大小\n    if len(content) > settings.MAX_FILE_SIZE:\n        size_mb = len(content) / 1024 / 1024\n        return False, f\"图片过大 ({size_mb:.1f}MB)，最大支持 10MB\"\n    \n    # 尺寸检查\n    try:\n        img = Image.open(BytesIO(content))\n        w, h = img.size\n        if w > settings.MAX_DIMENSION or h > settings.MAX_DIMENSION:\n            return False, f\"图片尺寸过大 ({w}x{h})，最大支持 8192x8192\"\n        if w / h > 10 or h / w > 10:\n            return False, \"图片宽高比超过 10:1\"\n    except Exception as e:\n        return False, f\"无法解析图片: {str(e)}\"\n    \n    return True, \"\"\n\ndef compute_hash(content: bytes, source: str, target: str, field: str) -> str:\n    \"\"\"计算缓存 key: image_hash + params\"\"\"\n    image_hash = hashlib.md5(content).hexdigest()\n    return f\"{image_hash}:{source}:{target}:{field}\"\n```\n\n#### retry.py - 重试装饰器\n\n```python\nimport time\nimport logging\nfrom functools import wraps\n\nlogger = logging.getLogger(__name__)\n\ndef retry_on_failure(max_attempts: int = 3, delay: float = 1.0):\n    \"\"\"失败重试装饰器\"\"\"\n    def decorator(func):\n        @wraps(func)\n        def wrapper(*args, **kwargs):\n            last_error = None\n            for attempt in range(1, max_attempts + 1):\n                try:\n                    return func(*args, **kwargs)\n                except Exception as e:\n                    last_error = e\n                    logger.warning(f\"尝试 {attempt}/{max_attempts} 失败: {e}\")\n                    if attempt < max_attempts:\n                        time.sleep(delay * attempt)  # 指数退避\n            raise last_error\n        return wrapper\n    return decorator\n```\n\n## API Contract\n\n### POST /api/translate\n\n**Request:**\n```\nContent-Type: multipart/form-data\n\nfile: binary (required)\nsource_lang: string (default: \"auto\")\ntarget_lang: string (default: \"zh\")\nfield: string (default: \"e-commerce\")\nenable_postprocess: boolean (default: true)\n```\n\n**Response Success (200):**\n```\nContent-Type: image/png\nBody: binary (PNG image)\n```\n\n**Response Error (400/500):**\n```json\n{\n  \"error\": \"VALIDATION_ERROR\",\n  \"message\": \"图片过大 (12.5MB)，最大支持 10MB\"\n}\n```\n\n### GET /health\n\n**Response:**\n```json\n{\n  \"status\": \"healthy\",\n  \"version\": \"1.0.0\"\n}\n```\n\n## Frontend Integration\n\n### API Client (React)\n\n```typescript\n// src/api/translateClient.ts\nconst API_BASE = import.meta.env.VITE_API_URL || 'http://localhost:8000';\n\nexport interface TranslateOptions {\n  sourceLang?: string;\n  targetLang?: string;\n  field?: string;\n  enablePostprocess?: boolean;\n}\n\nexport async function translateImage(\n  file: File,\n  options: TranslateOptions = {}\n): Promise<Blob> {\n  const formData = new FormData();\n  formData.append('file', file);\n  formData.append('source_lang', options.sourceLang || 'auto');\n  formData.append('target_lang', options.targetLang || 'zh');\n  formData.append('field', options.field || 'e-commerce');\n  formData.append('enable_postprocess', String(options.enablePostprocess ?? true));\n\n  const response = await fetch(`${API_BASE}/api/translate`, {\n    method: 'POST',\n    body: formData,\n  });\n\n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.message || '翻译失败');\n  }\n\n  return response.blob();\n}\n```\n\n### State Management (React Hook)\n\n```typescript\n// src/hooks/useTranslation.ts\nimport { useState, useCallback } from 'react';\nimport { translateImage, TranslateOptions } from '../api/translateClient';\n\ninterface TranslationState {\n  isLoading: boolean;\n  error: string | null;\n  result: Blob | null;\n  resultUrl: string | null;\n}\n\nexport function useTranslation() {\n  const [state, setState] = useState<TranslationState>({\n    isLoading: false,\n    error: null,\n    result: null,\n    resultUrl: null,\n  });\n\n  const translate = useCallback(async (file: File, options?: TranslateOptions) => {\n    setState(prev => ({ ...prev, isLoading: true, error: null }));\n    \n    try {\n      const blob = await translateImage(file, options);\n      const url = URL.createObjectURL(blob);\n      setState({ isLoading: false, error: null, result: blob, resultUrl: url });\n      return url;\n    } catch (e) {\n      const message = e instanceof Error ? e.message : '未知错误';\n      setState(prev => ({ ...prev, isLoading: false, error: message }));\n      throw e;\n    }\n  }, []);\n\n  const reset = useCallback(() => {\n    if (state.resultUrl) {\n      URL.revokeObjectURL(state.resultUrl);\n    }\n    setState({ isLoading: false, error: null, result: null, resultUrl: null });\n  }, [state.resultUrl]);\n\n  return { ...state, translate, reset };\n}\n```\n\n## Data Flow\n\n```\n1. 用户上传图片 (Dashboard)\n   ↓\n2. 前端验证 (格式、大小)\n   ↓\n3. POST /api/translate (multipart/form-data)\n   ↓\n4. 后端验证 (MIME、尺寸、宽高比)\n   ↓\n5. 计算缓存 key (MD5 hash + params)\n   ↓\n6. 缓存命中? → 返回缓存结果\n   ↓ (未命中)\n7. ThreadPoolExecutor 执行翻译\n   ↓\n8. 调用阿里云 API (带重试)\n   ↓\n9. 后处理优化 (数字转换、术语修正)\n   ↓\n10. 存入缓存 + 返回 PNG\n   ↓\n11. 前端显示结果 (Editor)\n   ↓\n12. 用户下载/返回\n```\n\n## Error Handling Strategy\n\n| 错误类型 | HTTP 状态码 | 前端处理 |\n|----------|------------|----------|\n| 格式不支持 | 400 | 显示 \"仅支持 JPG、PNG、WebP\" |\n| 文件过大 | 400 | 显示 \"最大支持 10MB\" |\n| 尺寸超限 | 400 | 显示 \"最大支持 8192x8192\" |\n| 阿里云 API 失败 | 500 | 显示 \"翻译服务暂时不可用，请重试\" |\n| 网络超时 | 504 | 显示 \"请求超时，请重试\" |\n\n## Security Considerations\n\n1. **CORS**: 白名单域名，生产环境仅允许前端域名\n2. **文件验证**: 服务端二次验证，不信任 Content-Type\n3. **环境变量**: API Key 通过 .env 注入，不硬编码\n4. **限流**: 可选 slowapi 中间件 (5 QPS)\n\n## Deployment Changes\n\n### Dockerfile 更新\n\n```dockerfile\nFROM python:3.11-slim\n\nWORKDIR /app\nCOPY requirements.txt .\nRUN pip install --no-cache-dir -r requirements.txt\n\nCOPY . .\n\nEXPOSE 8000\n\nHEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \\\n  CMD curl -f http://localhost:8000/health || exit 1\n\nCMD [\"uvicorn\", \"api.main:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8000\"]\n```\n\n### requirements.txt 新增\n\n```\nfastapi>=0.104.0\nuvicorn[standard]>=0.24.0\npydantic-settings>=2.0.0\npython-multipart>=0.0.6\n```\n\n## Testing Strategy\n\n- **单元测试**: services/, utils/ 层\n- **集成测试**: API 端点 (pytest + httpx)\n- **E2E 测试**: 前后端联调\n\n## Risks and Mitigations\n\n| 风险 | 等级 | 缓解措施 |\n|------|------|----------|\n| 阿里云 API 阻塞 | 高 | ThreadPoolExecutor 隔离 |\n| 高并发缓存穿透 | 中 | 缓存锁 + TTL |\n| 大文件内存溢出 | 中 | 流式读取 + 大小限制 |\n| 前端状态不一致 | 低 | 单一数据源 hook |\n\n## Decision Log\n\n- **2024-12-04**: 选择方案 A (全量分层架构)，Codex 审查通过\n- **上传方式**: multipart/form-data (避免 base64 33% 开销)\n- **缓存策略**: LRU + TTL (基于 image hash + language pair)\n- **状态管理**: React 内部状态 (MVP 阶段足够)\n",
  "fileStats": {
    "size": 17994,
    "lines": 631,
    "lastModified": "2025-12-04T03:02:29.687Z"
  },
  "comments": []
}